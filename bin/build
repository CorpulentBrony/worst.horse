#!/bin/sh

# change working directory
cd "${0%/*}/.."

echo updating submodules...
git submodule update --remote --recursive

echo cleaning out js/ directory...
find ./js/ -maxdepth 9 ! -name ".*" ! -name "js" ! -name "README.md" -delete

echo transpiling web app...
./bin/tsc -p ./tsconfig.web.json

echo browserifying web app...
./bin/browserify ./js/index.js --debug -o ./js/main.js # | ./bin/exorcist ./js/main.js.map > ./js/main.js

# disabling exorcist for now
#./bin/browserify ./js/index.js --debug | ./bin/exorcist ./js/main.js.map > ./js/main.js

echo uglifying js...
./bin/uglifyjs ./js/main.js --compress dead_code,conditionals,comparisons,evaluate,booleans,loops,unused,if_return,reduce_vars,passes=3,keep_fargs=false --mangle --source-map root="https://worst.horse/js",url=main.min.js.map,content=inline --output ./js/main.min.js

echo cleaning out css/ directory...
find ./css/ -maxdepth 9 ! -name ".*" ! -name "css" ! -name "README.md" -delete

echo transpiling scss to css...
find ./scss/ -maxdepth 1 -name "*.scss" -type f -exec sh -c 'scss --style expanded --default-encoding UTF-8 "{}" css/$(basename "{}" ".scss").css' \;

echo autoprefixing and minifying css...
./bin/postcss css/index.css --use autoprefixer --use cssnano | ./bin/exorcist --root / --url /css/index.min.css.map ./css/index.min.css.map > ./css/index.min.css

echo transpiling server app...
./bin/tsc

echo making server app executable...
chmod +x ./js/server/image.js